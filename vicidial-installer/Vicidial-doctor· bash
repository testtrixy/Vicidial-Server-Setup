#!/usr/bin/env bash
# ------------------------------------------------------------
# vicidial-doctor.sh — VICIdial Diagnostics & Guided Remediation
# ------------------------------------------------------------
# Safe to run anytime. Read-only by default.
# ------------------------------------------------------------

set -euo pipefail

RED="\e[31m"; GREEN="\e[32m"; YELLOW="\e[33m"; NC="\e[0m"

ok()   { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
fail() { echo -e "${RED}[FAIL]${NC} $1"; }

banner() {
  echo "============================================================"
  echo "$1"
  echo "============================================================"
}

banner "VICIdial Doctor — Diagnostic Mode"

ISSUES=0

# ------------------------------------------------------------
# 1. Web Layer
# ------------------------------------------------------------
banner "Web Layer"

if systemctl is-active --quiet httpd; then
  ok "Apache running"
else
  fail "Apache not running"; ((ISSUES++))
  echo "  Fix: systemctl start httpd"
fi

if [[ -f /var/www/html/index.html ]]; then
  warn "Apache default test page present"
  echo "  Suggestion: mv /var/www/html/index.html /root/index.html.bak"
fi

if [[ -f /var/www/html/vicidial/admin.php ]]; then
  ok "VICIdial admin.php present"
else
  fail "VICIdial web files missing"; ((ISSUES++))
fi

# ------------------------------------------------------------
# 2. PHP Layer
# ------------------------------------------------------------
banner "PHP Layer"

if command -v php >/dev/null 2>&1; then
  ok "PHP installed"
else
  fail "PHP missing"; ((ISSUES++))
  echo "  Fix: dnf install php php-mysqlnd php-mbstring php-xml php-gd"
fi

for m in mysqlnd mbstring xml gd; do
  if php -m | grep -qi "^$m$"; then
    ok "PHP module loaded: $m"
  else
    fail "Missing PHP module: $m"; ((ISSUES++))
    echo "  Fix: dnf install php-$m"
  fi
done

# ------------------------------------------------------------
# 3. Database Layer
# ------------------------------------------------------------
banner "Database Layer"

if systemctl is-active --quiet mariadb; then
  ok "MariaDB running"
else
  fail "MariaDB not running"; ((ISSUES++))
  echo "  Fix: systemctl start mariadb"
fi

if [[ -f /etc/astguiclient.conf ]]; then
  DB_USER=$(grep '^VARDB_user=' /etc/astguiclient.conf | cut -d= -f2)
  DB_PASS=$(grep '^VARDB_pass=' /etc/astguiclient.conf | cut -d= -f2)
  DB_NAME=$(grep '^VARDB_database=' /etc/astguiclient.conf | cut -d= -f2)

  if mysql -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -e 'SHOW TABLES;' >/dev/null 2>&1; then
    ok "DB credentials valid"
  else
    fail "DB credential mismatch"; ((ISSUES++))
    echo "  Fix: GRANT permissions or correct astguiclient.conf"
  fi
else
  fail "astguiclient.conf missing"; ((ISSUES++))
fi

# ------------------------------------------------------------
# 4. Perl / astguiclient
# ------------------------------------------------------------
banner "Perl & astguiclient"

for p in DBI DBD::mysql Unicode::Map Jcode Spreadsheet::WriteExcel Mail::Sendmail; do
  if perl -M"$p" -e1 >/dev/null 2>&1; then
    ok "Perl module OK: $p"
  else
    fail "Missing Perl module: $p"; ((ISSUES++))
    echo "  Fix: cpanm $p"
  fi
done

# ------------------------------------------------------------
# 5. DAHDI / Timing
# ------------------------------------------------------------
banner "DAHDI / Timing"

if command -v dahdi_cfg >/dev/null 2>&1; then
  if dahdi_cfg -t >/dev/null 2>&1; then
    ok "DAHDI timing active"
  else
    fail "DAHDI timing inactive"; ((ISSUES++))
    echo "  Fix: modprobe dahdi_dummy && dahdi_cfg"
  fi
else
  fail "DAHDI tools missing"; ((ISSUES++))
fi

# ------------------------------------------------------------
# 6. VICIdial Runtime
# ------------------------------------------------------------
banner "VICIdial Runtime"

if screen -ls | grep -q Detached; then
  ok "VICIdial screen sessions running"
else
  fail "No VICIdial screen sessions"; ((ISSUES++))
  echo "  Fix: systemctl restart vicidial (or start scripts manually)"
fi

# ------------------------------------------------------------
# Final Summary
# ------------------------------------------------------------
banner "Doctor Summary"

if [[ "$ISSUES" -eq 0 ]]; then
  echo -e "${GREEN}System healthy. No issues detected.${NC}"
else
  echo -e "${RED}$ISSUES issue(s) detected. Review fixes above.${NC}"
fi

exit 0